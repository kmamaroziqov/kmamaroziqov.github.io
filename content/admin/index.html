<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Write</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Crimson Pro', Georgia, serif;
      background: #faf8f5;
      color: #2d2a26;
      min-height: 100vh;
      line-height: 1.7;
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3rem;
    }

    .logo {
      font-size: 1.125rem;
      font-weight: 500;
      color: #8a8580;
      letter-spacing: -0.01em;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .user-name {
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      color: #a09a94;
    }

    /* Buttons */
    .btn {
      font-family: 'Inter', sans-serif;
      padding: 0.5rem 0.875rem;
      border: none;
      border-radius: 5px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }

    .btn-ghost {
      background: transparent;
      color: #8a8580;
    }

    .btn-ghost:hover {
      color: #2d2a26;
      background: #f0ece6;
    }

    .btn-soft {
      background: #f0ece6;
      color: #5c5650;
    }

    .btn-soft:hover {
      background: #e6e0d8;
    }

    .btn-primary {
      background: #2d2a26;
      color: #faf8f5;
    }

    .btn-primary:hover {
      background: #1a1816;
    }

    .btn-telegram {
      background: #0088cc;
      color: white;
    }

    .btn-telegram:hover {
      background: #006da3;
    }

    /* Form */
    .write-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .form-group label {
      display: block;
      font-family: 'Inter', sans-serif;
      font-size: 0.6875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #a09a94;
      margin-bottom: 0.5rem;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 0.75rem;
      background: #fff;
      border: 1px solid #e6e0d8;
      border-radius: 6px;
      font-family: inherit;
      font-size: 1rem;
      color: #2d2a26;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #c9c3bb;
      box-shadow: 0 0 0 3px rgba(45, 42, 38, 0.05);
    }

    input::placeholder,
    textarea::placeholder {
      color: #c9c3bb;
    }

    .title-input {
      font-size: 1.75rem;
      font-weight: 500;
      border: none;
      background: transparent;
      padding: 0;
    }

    .title-input:focus {
      box-shadow: none;
    }

    .body-textarea {
      min-height: 400px;
      resize: vertical;
      font-size: 1.125rem;
      line-height: 1.8;
    }

    .meta-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 500px) {
      .meta-row { grid-template-columns: 1fr; }
    }

    /* Actions */
    .actions {
      display: flex;
      gap: 0.5rem;
      padding-top: 1rem;
      border-top: 1px solid #e6e0d8;
      flex-wrap: wrap;
    }

    .actions-right {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
    }

    /* Posts list */
    .posts-section {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid #e6e0d8;
    }

    .posts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .posts-header h2 {
      font-size: 0.8125rem;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: #8a8580;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .posts-list {
      list-style: none;
    }

    .post-item {
      padding: 0.875rem 0;
      border-bottom: 1px solid #f0ece6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.1s;
    }

    .post-item:hover {
      background: #fdfcfa;
      margin: 0 -0.75rem;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
      border-radius: 4px;
    }

    .post-title {
      font-size: 1rem;
      color: #2d2a26;
    }

    .post-date {
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      color: #a09a94;
    }

    /* Auth screen */
    .auth-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
      text-align: center;
    }

    .auth-screen h2 {
      font-size: 1.5rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #2d2a26;
    }

    .auth-screen p {
      color: #8a8580;
      margin-bottom: 1.5rem;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      padding: 0.75rem 1.25rem;
      background: #2d2a26;
      color: #faf8f5;
      border-radius: 6px;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.25s ease;
      z-index: 100;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.error {
      background: #c53030;
    }

    .hidden { display: none !important; }

    /* Settings toggle */
    .settings-panel {
      margin-top: 2rem;
      padding: 1.25rem;
      background: #fff;
      border: 1px solid #e6e0d8;
      border-radius: 8px;
    }

    .settings-panel h3 {
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      color: #8a8580;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
    }

    .settings-grid {
      display: grid;
      gap: 1rem;
    }

    /* Delete button */
    .btn-delete {
      background: transparent;
      color: #c53030;
      border: 1px solid #c53030;
    }

    .btn-delete:hover {
      background: #c53030;
      color: white;
    }

    /* AI Panel */
    .btn-ai {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
    }

    .btn-ai:hover {
      background: linear-gradient(135deg, #7c3aed, #4f46e5);
    }

    .ai-panel {
      margin-top: 1.5rem;
      padding: 1rem;
      background: #f8f6f3;
      border: 1px solid #e6e0d8;
      border-radius: 8px;
    }

    .ai-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .ai-panel h4 {
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      color: #8b5cf6;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .ai-actions {
      display: flex;
      gap: 0.375rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }

    .ai-chip {
      font-family: 'Inter', sans-serif;
      padding: 0.375rem 0.625rem;
      background: #fff;
      border: 1px solid #e6e0d8;
      border-radius: 16px;
      font-size: 0.75rem;
      color: #5c5650;
      cursor: pointer;
      transition: all 0.15s;
    }

    .ai-chip:hover {
      border-color: #8b5cf6;
      color: #8b5cf6;
    }

    .ai-output {
      background: #fff;
      border: 1px solid #e6e0d8;
      border-radius: 6px;
      padding: 0.75rem;
      font-size: 0.9375rem;
      color: #5c5650;
      min-height: 80px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.6;
    }

    .ai-output-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div id="authScreen" class="container auth-screen">
    <h2>Welcome</h2>
    <p>Sign in to write and publish</p>
    <button class="btn btn-primary" onclick="startAuth()">
      Sign in with GitHub
    </button>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="container hidden">
    <header>
      <span class="logo">âœŽ Write</span>
      <div class="header-actions">
        <span id="userInfo" class="user-name"></span>
        <button class="btn btn-ghost" onclick="toggleSettings()">âš™</button>
        <button class="btn btn-ghost" onclick="logout()">Sign out</button>
      </div>
    </header>

    <!-- Write Form -->
    <form id="postForm" class="write-form">
      <div class="form-group">
        <input type="text" id="title" class="title-input" placeholder="Title" required>
      </div>

      <div class="form-group">
        <textarea id="body" class="body-textarea" placeholder="Write your thoughts..."></textarea>
      </div>

      <div class="meta-row">
        <div class="form-group">
          <label for="slug">Slug</label>
          <input type="text" id="slug" placeholder="url-friendly-name">
        </div>
        <div class="form-group">
          <label for="tags">Tags</label>
          <input type="text" id="tags" placeholder="AI, notes">
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-ai" onclick="toggleAiPanel()">
          âœ¨ AI Refine
        </button>
        <button type="button" class="btn btn-telegram" onclick="postToTelegram()">
          ðŸ“¨ Send to Telegram
        </button>
        <div class="actions-right">
          <button type="button" id="deleteBtn" class="btn btn-delete hidden" onclick="deleteCurrentPost()">
            Delete
          </button>
          <button type="button" class="btn btn-soft" onclick="resetForm()">
            New
          </button>
          <button type="submit" class="btn btn-primary">
            Publish
          </button>
        </div>
      </div>
    </form>

    <!-- AI Panel -->
    <div id="aiPanel" class="ai-panel hidden">
      <div class="ai-panel-header">
        <h4>âœ¨ AI Assistant</h4>
        <button class="btn btn-ghost" onclick="toggleAiPanel()" style="padding: 0.25rem 0.5rem;">âœ•</button>
      </div>
      <div class="ai-actions">
        <button class="ai-chip" onclick="aiRefine('improve')">Improve writing</button>
        <button class="ai-chip" onclick="aiRefine('shorten')">Make concise</button>
        <button class="ai-chip" onclick="aiRefine('telegram')">Telegram format</button>
        <button class="ai-chip" onclick="aiRefine('grammar')">Fix grammar</button>
      </div>
      <div id="aiOutput" class="ai-output">AI suggestions will appear here...</div>
      <div class="ai-output-actions">
        <button class="btn btn-soft" onclick="applyAiSuggestion()">Apply to post</button>
        <button class="btn btn-ghost" onclick="copyAiOutput()">Copy</button>
      </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel hidden">
      <h3>Settings</h3>
      <div class="settings-grid">
        <div class="form-group">
          <label for="geminiKey">Gemini API Key</label>
          <input type="text" id="geminiKey" placeholder="AIza...">
          <small style="font-size: 0.7rem; color: #a09a94; display: block; margin-top: 0.25rem;">Get free key at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #8b5cf6;">Google AI Studio</a></small>
        </div>
        <div class="form-group">
          <label for="telegramToken">Telegram Bot Token</label>
          <input type="text" id="telegramToken" placeholder="123456:ABC-DEF...">
        </div>
        <div class="form-group">
          <label for="telegramChat">Telegram Channel ID</label>
          <input type="text" id="telegramChat" placeholder="@channelname or -100...">
        </div>
        <button class="btn btn-soft" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>

    <!-- Posts List -->
    <section class="posts-section">
      <div class="posts-header">
        <h2>Your Posts</h2>
      </div>
      <ul id="postsList" class="posts-list">
        <li style="color: #a09a94; padding: 1rem 0;">Loading...</li>
      </ul>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // Config
    const CONFIG = {
      repo: 'kmamaroziqov/kmamaroziqov.github.io',
      branch: 'main',
      postsPath: 'content/posts',
      oauthUrl: 'https://decap-oauth-zeta.vercel.app',
      siteUrl: 'https://kmamaroziqov.github.io',
      allowedAdmins: ['kmamaroziqov']
    };

    let accessToken = localStorage.getItem('github_token');
    let currentEditingFile = null;

    // Auth
    function startAuth() {
      const popup = window.open(`${CONFIG.oauthUrl}/api/auth`, 'GitHub Auth', 'width=600,height=700');
      
      const handler = (e) => {
        if (e.data?.startsWith?.('authorization:github:success:')) {
          const data = JSON.parse(e.data.replace('authorization:github:success:', ''));
          accessToken = data.token;
          localStorage.setItem('github_token', accessToken);
          window.removeEventListener('message', handler);
          popup?.close();
          showToast('Signed in!');
          initApp();
        }
      };
      window.addEventListener('message', handler);
    }

    function logout() {
      localStorage.removeItem('github_token');
      accessToken = null;
      document.getElementById('authScreen').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    // Init
    async function initApp() {
      if (!accessToken) {
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        return;
      }

      try {
        const user = await githubApi('/user');
        if (!CONFIG.allowedAdmins.includes(user.login)) {
          showToast('Access denied', true);
          logout();
          return;
        }
        
        document.getElementById('userInfo').textContent = `@${user.login}`;
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        loadSettings();
        loadPosts();
      } catch (e) {
        logout();
      }
    }

    // GitHub API
    async function githubApi(endpoint, options = {}) {
      const url = endpoint.startsWith('http') ? endpoint : `https://api.github.com${endpoint}`;
      const res = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `token ${accessToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
          ...options.headers
        }
      });
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return res.json();
    }

    // Load posts
    async function loadPosts() {
      try {
        const files = await githubApi(`/repos/${CONFIG.repo}/contents/${CONFIG.postsPath}?ref=${CONFIG.branch}`);
        const posts = files.filter(f => f.name.endsWith('.md')).reverse();
        
        const list = document.getElementById('postsList');
        if (!posts.length) {
          list.innerHTML = '<li style="color: #a09a94; padding: 1rem 0;">No posts yet. Start writing!</li>';
          return;
        }

        list.innerHTML = posts.map(p => `
          <li class="post-item" onclick="editPost('${p.path}')">
            <span class="post-title">${p.name.replace('.md', '').replace(/-/g, ' ')}</span>
            <span class="post-date">Edit â†’</span>
          </li>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    // Edit post
    async function editPost(path) {
      try {
        showToast('Loading...');
        const file = await githubApi(`/repos/${CONFIG.repo}/contents/${path}?ref=${CONFIG.branch}`);
        const content = atob(file.content);
        
        currentEditingFile = { path, sha: file.sha };
        
        const lines = content.split('\n');
        let bodyStart = 0;
        const meta = {};
        
        for (let i = 0; i < lines.length; i++) {
          if (!lines[i].trim()) { bodyStart = i + 1; break; }
          if (lines[i].includes(':')) {
            const [key, ...vals] = lines[i].split(':');
            meta[key.trim().toLowerCase()] = vals.join(':').trim();
          }
        }

        document.getElementById('title').value = meta.title || '';
        document.getElementById('slug').value = meta.slug || '';
        document.getElementById('tags').value = meta.tags || '';
        document.getElementById('body').value = lines.slice(bodyStart).join('\n').trim();
        document.getElementById('deleteBtn').classList.remove('hidden');
        
        showToast('Loaded!');
      } catch (e) {
        showToast('Failed to load', true);
      }
    }

    // Save post
    document.getElementById('postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const title = document.getElementById('title').value;
      const slug = document.getElementById('slug').value || slugify(title);
      const tags = document.getElementById('tags').value;
      const body = document.getElementById('body').value;
      const date = new Date().toISOString().split('T')[0];

      const content = `Title: ${title}
Date: ${date}
Tags: ${tags}
Slug: ${slug}
Author: Kamronbek Mamaroziqov

${body}
`;

      const path = currentEditingFile?.path || `${CONFIG.postsPath}/${slug}.md`;
      const payload = {
        message: currentEditingFile ? `Update: ${title}` : `New post: ${title}`,
        content: btoa(unescape(encodeURIComponent(content))),
        branch: CONFIG.branch
      };
      
      if (currentEditingFile?.sha) payload.sha = currentEditingFile.sha;

      try {
        showToast('Saving...');
        await githubApi(`/repos/${CONFIG.repo}/contents/${path}`, {
          method: 'PUT',
          body: JSON.stringify(payload)
        });
        showToast('Published!');
        resetForm();
        loadPosts();
      } catch (e) {
        showToast('Failed to save', true);
      }
    });

    // Delete post
    async function deleteCurrentPost() {
      if (!currentEditingFile || !confirm('Delete this post?')) return;
      
      try {
        showToast('Deleting...');
        await githubApi(`/repos/${CONFIG.repo}/contents/${currentEditingFile.path}`, {
          method: 'DELETE',
          body: JSON.stringify({
            message: `Delete post`,
            sha: currentEditingFile.sha,
            branch: CONFIG.branch
          })
        });
        showToast('Deleted!');
        resetForm();
        loadPosts();
      } catch (e) {
        showToast('Failed to delete', true);
      }
    }

    // Telegram - Using HTML parse mode for reliable formatting
    async function postToTelegram() {
      const token = localStorage.getItem('telegram_token');
      const chatId = localStorage.getItem('telegram_chat');
      
      if (!token || !chatId) {
        showToast('Configure Telegram in settings', true);
        document.getElementById('settingsPanel').classList.remove('hidden');
        return;
      }

      const title = document.getElementById('title').value;
      const body = document.getElementById('body').value;
      const slug = document.getElementById('slug').value || slugify(title);
      const link = `${CONFIG.siteUrl}/posts/${slug}/`;

      // Convert markdown to Telegram HTML format
      const htmlContent = markdownToTelegramHtml(body);
      
      const message = `<b>${escapeHtml(title)}</b>\n\n${htmlContent}\n\nðŸ”— <a href="${link}">Read more</a>\n\n@lab_log`;

      try {
        showToast('Sending to Telegram...');
        const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: chatId,
            text: message,
            parse_mode: 'HTML',
            disable_web_page_preview: false
          })
        });

        const data = await res.json();
        if (data.ok) {
          showToast('Sent to Telegram!');
        } else {
          throw new Error(data.description);
        }
      } catch (e) {
        console.error(e);
        showToast(`Telegram error: ${e.message}`, true);
      }
    }

    // Convert markdown to Telegram HTML
    function markdownToTelegramHtml(text) {
      let html = text;
      
      // First escape HTML entities in plain text
      // But we need to be careful not to escape our own tags
      
      // Process code blocks first (protect them)
      const codeBlocks = [];
      html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
        codeBlocks.push(`<pre>${escapeHtml(code.trim())}</pre>`);
        return `__CODE_BLOCK_${codeBlocks.length - 1}__`;
      });
      
      // Process inline code
      const inlineCodes = [];
      html = html.replace(/`([^`]+)`/g, (match, code) => {
        inlineCodes.push(`<code>${escapeHtml(code)}</code>`);
        return `__INLINE_CODE_${inlineCodes.length - 1}__`;
      });
      
      // Now escape remaining HTML
      html = escapeHtml(html);
      
      // Restore code blocks and inline code
      codeBlocks.forEach((block, i) => {
        html = html.replace(`__CODE_BLOCK_${i}__`, block);
      });
      inlineCodes.forEach((code, i) => {
        html = html.replace(`__INLINE_CODE_${i}__`, code);
      });
      
      // Convert markdown formatting
      // Bold: **text** or __text__
      html = html.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
      html = html.replace(/__(.+?)__/g, '<b>$1</b>');
      
      // Italic: *text* or _text_
      html = html.replace(/(?<![*_])\*([^*]+)\*(?![*_])/g, '<i>$1</i>');
      html = html.replace(/(?<![*_])_([^_]+)_(?![*_])/g, '<i>$1</i>');
      
      // Strikethrough: ~~text~~
      html = html.replace(/~~(.+?)~~/g, '<s>$1</s>');
      
      // Links: [text](url)
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
      
      // Remove image markdown (Telegram doesn't support inline images in text)
      html = html.replace(/!\[([^\]]*)\]\([^)]+\)/g, 'ðŸ–¼ $1');
      
      // Remove headers markdown (just keep text, make bold)
      html = html.replace(/^#{1,6}\s+(.+)$/gm, '<b>$1</b>');
      
      // Clean up multiple newlines
      html = html.replace(/\n{3,}/g, '\n\n');
      
      return html.trim();
    }

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;'
      };
      return text.replace(/[&<>]/g, c => map[c]);
    }

    // AI Functions
    function toggleAiPanel() {
      document.getElementById('aiPanel').classList.toggle('hidden');
    }

    async function aiRefine(action) {
      const geminiKey = localStorage.getItem('gemini_key');
      if (!geminiKey) {
        showToast('Add Gemini API key in settings', true);
        document.getElementById('settingsPanel').classList.remove('hidden');
        return;
      }

      const body = document.getElementById('body').value;
      const title = document.getElementById('title').value;

      if (!body) {
        showToast('Write some content first', true);
        return;
      }

      const prompts = {
        improve: `Improve this blog post. Make it more engaging and clear while keeping the same meaning. Return only the improved text:\n\n${body}`,
        shorten: `Make this text more concise without losing key information. Return only the shortened text:\n\n${body}`,
        telegram: `Convert this into an engaging Telegram post. Use:\n- Emoji at the start\n- Key points as bullets (use â€¢)\n- Keep under 280 words\n- Add 2-3 hashtags\n\nTitle: ${title}\nContent: ${body.substring(0, 1500)}`,
        grammar: `Fix grammar, spelling, and punctuation in this text. Return only the corrected text:\n\n${body}`
      };

      document.getElementById('aiOutput').textContent = 'Thinking...';
      document.getElementById('aiPanel').classList.remove('hidden');

      try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompts[action] }] }]
          })
        });

        const data = await res.json();
        console.log('Gemini response:', data);
        
        if (data.error) {
          document.getElementById('aiOutput').textContent = 'Error: ' + (data.error.message || JSON.stringify(data.error));
          showToast('AI error', true);
          return;
        }

        const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!result) {
          document.getElementById('aiOutput').textContent = 'No response from AI. Response: ' + JSON.stringify(data);
          return;
        }
        
        document.getElementById('aiOutput').textContent = result;
        showToast('AI ready!');
      } catch (e) {
        console.error('Gemini error:', e);
        document.getElementById('aiOutput').textContent = 'Request failed: ' + e.message;
        showToast('AI error', true);
      }
    }

    function applyAiSuggestion() {
      const suggestion = document.getElementById('aiOutput').textContent;
      if (suggestion && !suggestion.startsWith('AI suggestions') && !suggestion.startsWith('Thinking') && !suggestion.startsWith('Rate limited')) {
        document.getElementById('body').value = suggestion;
        showToast('Applied!');
      }
    }

    function copyAiOutput() {
      navigator.clipboard.writeText(document.getElementById('aiOutput').textContent);
      showToast('Copied!');
    }

    // Settings
    function toggleSettings() {
      document.getElementById('settingsPanel').classList.toggle('hidden');
    }

    function saveSettings() {
      localStorage.setItem('gemini_key', document.getElementById('geminiKey').value);
      localStorage.setItem('telegram_token', document.getElementById('telegramToken').value);
      localStorage.setItem('telegram_chat', document.getElementById('telegramChat').value);
      showToast('Settings saved!');
      document.getElementById('settingsPanel').classList.add('hidden');
    }

    function loadSettings() {
      document.getElementById('geminiKey').value = localStorage.getItem('gemini_key') || '';
      document.getElementById('telegramToken').value = localStorage.getItem('telegram_token') || '';
      document.getElementById('telegramChat').value = localStorage.getItem('telegram_chat') || '';
    }

    // Utils
    function slugify(text) {
      return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }

    function resetForm() {
      currentEditingFile = null;
      document.getElementById('postForm').reset();
      document.getElementById('deleteBtn').classList.add('hidden');
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // Auto-generate slug
    document.getElementById('title').addEventListener('input', (e) => {
      if (!currentEditingFile) {
        document.getElementById('slug').value = slugify(e.target.value);
      }
    });

    // Init on load
    initApp();
  </script>
</body>
</html>
